#!/bin/bash
# ############################################################################################
# File: ........: deployPCF.sh
# Language .....: bash
# Author .......: Sacha Dubois, Pivotal
# Description ..: PCF Installation and Configuration Utility
# ############################################################################################

export PCFHOME=$(cd "$PWD/$(dirname $0)"; pwd)
export PCFPATH=$(cd "$PWD/$(dirname $0)"; pwd)

. $PCFPATH/functions

listDeployments() {
  printf "%-25s %-5s %-10s %-10s %s\n" "CONFIURATION" "CLOUD" "DEPLOYMENT" "MAINTAINER" "DESCRIPTION" 
  echo "-----------------------------------------------------------------------------------------------------------"

  for deployment in $(ls -1 ${PCFPATH}/deployments/*.cfg); do
    . $deployment

    dep=$(basename $deployment) 

    if [ "$PCF_TILE_PKS_VERSION" != "" ]; then 
      TILE="PKS $PCF_TILE_PKS_VERSION"
    else
      TILE="PAS $PCF_TILE_PAS_VERSION"
    fi

    printf "%-25s %-5s %-10s %-10s %s\n" $dep $PCF_DEPLOYMENT_CLOUD "$TILE" $PCF_DEPLOYMENT_MAINTAINER \
           "$PCF_DEPLOYMENT_DESCRIPTION"
  done
  
  echo "-----------------------------------------------------------------------------------------------------------"
}

usage() {
  echo "USAGE: $PCFDEPLOY [oprions] <deployment.cfg>"
  echo "                   --cleanup    # Cleanup previous installation and stop"
  echo "                                # the jump server"
}

LIST_DEPLOYMENTS=0
USAGE=0
CLEANUP=0
PCFMODE=""

echo ""
echo "PCF Deployment Utility ($PCFDEPLOY)"
echo "by Sacha Dubois, Pivotal Inc,"
echo "-----------------------------------------------------------------------------------------------------------"

while [ "$1" != "" ]; do
  if [ "$1" == "--cleanup" ]; then 
    CLEANUP=1
  else 
    cnt=$(echo "$1" | egrep -c "^\-") 
    [ $cnt -eq 0 ] && DEPLOYMENT=$1
  fi
  shift
done

if [ "${DEPLOYMENT}" == "" ]; then
  listDeployments
  usage; exit 0
fi

# --- VERIFY DEPLOYMENT ---
if [ ! -f ${PCFPATH}/deployments/${DEPLOYMENT} ]; then 
  echo "ERROR: Deployment file $pcf_deployment can not be found in ${PCFPATH}/deployments"
  exit 1
fi

cnt=$(egrep -c "^PCF_DEPLOYMENT_CLOUD=" ${PCFPATH}/deployments/$DEPLOYMENT)
if [ $cnt -eq 0 ]; then
  echo "ERROR: $pcf_deployment is not a correct PCFCONFIG deployment configuration file"
  exit 1
else
  missing_variables=0

  .  ${PCFPATH}/deployments/${DEPLOYMENT}
  if [ $? -ne 0 ]; then 
    echo "ERROR: in ${PCFPATH}/deployments/${DEPLOYMENT}"
    exit 1
  fi

  # --- CHECK ENVIRONMENT VARIABLES ---
  if [ -f ~/.pcfconfig ]; then 
    . ~/.pcfconfig
  fi

  echo "Deployment Settings"
  messagePrint " - Cloud Provider"           "$PCF_DEPLOYMENT_CLOUD"
  messagePrint " - Environment Name"         "$PCF_DEPLOYMENT_ENV_NAME"
  messagePrint " - Deployment Description"   "$PCF_DEPLOYMENT_DESCRIPTION"
  messagePrint " - Debug Information"        "$PCF_DEPLOYMENT_DEBUG"

  echo "Operation Manager Configuration"
  messagePrint " - OpsManager Version"       "$PCF_OPSMANAGER_VERSION"
  messagePrint " - OM Configuration File"    "$PCF_OPSMANAGER_CONFIG"
  messagePrint " - Administrator User"       "$PCF_OPSMANAGER_ADMIN_USER"
  messagePrint " - Administrator Password"   "$PCF_OPSMANAGER_ADMIN_PASS"

  if [ "${PCF_TILE_PKS_DEPLOY}" == "true" ]; then
    if [ "${PCF_TILE_PKS_ADMIN_USER}" == "" -o "${PCF_TILE_PKS_ADMIN_PASS}" == "" -o "${PCF_TILE_PKS_ADMIN_EMAIL}" == "" ]; then
      missing_variables=1
      echo ""
      echo "  MISSING ENVIRONMENT-VARIABES    DESCRIPTION        "
      echo "  --------------------------------------------------------------------------------------------------------------"

      if [ "${PCF_TILE_PKS_ADMIN_USER}" == "" ]; then
        echo "  PCF_TILE_PKS_ADMIN_USER       (required) PKS Administrator User"
      fi

      if [ "${PCF_TILE_PKS_ADMIN_PASS}" == "" ]; then
        echo "  PCF_TILE_PKS_ADMIN_PASS       (required) PKS Administrator Password"
      fi

      if [ "${PCF_TILE_PKS_ADMIN_EMAIL}" == "" ]; then
        echo "  PCF_TILE_PKS_ADMIN_EMAIL      (required) PKS Administrator Email"
      fi
    else
      echo "Pivotal Container Platform (PKS)"
      messagePrint " - PKS Version"                   "$PCF_TILE_PKS_VERSION"
      messagePrint " - PKS Product SLUG"              "$PCF_TILE_PKS_SLUG"
      messagePrint " - OM Configuration File"         "$PCF_TILE_PKS_CONFIG"
      messagePrint " - Config Description"            "$PCF_TILE_PKS_DESCRIPTION"
      messagePrint " - PAS Stemcell Type"             "$PCF_TILE_PKS_STEMCELL_TYPE"
      messagePrint " - PAS Stemcell Version"          "$PCF_TILE_PKS_STEMCELL_VERSION"
      messagePrint " - PKS Administrator User"        "$PCF_TILE_PKS_ADMIN_USER"
      messagePrint " - PKS Administrator Password"    "$PCF_TILE_PKS_ADMIN_PASS"
      messagePrint " - PKS Administrator Email"       "$PCF_TILE_PKS_ADMIN_EMAIL"
    fi
  fi

  if [ "${PCF_TILE_PAS_DEPLOY}" == "true" ]; then
    if [ "${PCF_TILE_PAS_ADMIN_USER}" == "" -o "${PCF_TILE_PAS_ADMIN_PASS}" == "" -o "${PCF_TILE_PAS_ADMIN_EMAIL}" == "" ]; then
      missing_variables=1
      echo ""
      echo "  MISSING ENVIRONMENT-VARIABES    DESCRIPTION        "
      echo "  --------------------------------------------------------------------------------------------------------------"

      if [ "${PCF_TILE_PAS_ADMIN_USER}" == "" ]; then
        echo "  PCF_TILE_PAS_ADMIN_USER       (required) CF Administrator User"
      fi

      if [ "${PCF_TILE_PAS_ADMIN_PASS}" == "" ]; then
        echo "  PCF_TILE_PAS_ADMIN_PASS       (required) CF Administrator Password"
      fi

      if [ "${PCF_TILE_PAS_ADMIN_EMAIL}" == "" ]; then
        echo "  PCF_TILE_PAS_ADMIN_EMAIL      (required) CF Administrator Email"
      fi
    else
      echo "Pivotal Container Platform (PAS)"
      messagePrint " - PAS Version"                   "$PCF_TILE_PAS_VERSION"
      messagePrint " - PAS Product SLUG"              "$PCF_TILE_PAS_SLUG"
      messagePrint " - OM Configuration File"         "$PCF_TILE_PAS_CONFIG"
      messagePrint " - OM Configuration Description"  "$PCF_TILE_PAS_DESCRIPTION"
      messagePrint " - PAS Stemcell Type"             "$PCF_TILE_PAS_STEMCELL_TYPE"
      messagePrint " - PAS Stemcell Version"          "$PCF_TILE_PAS_STEMCELL_VERSION"
      messagePrint " - PAS Administrator User"        "$PCF_TILE_PAS_ADMIN_USER"
      messagePrint " - PAS Administrator Password"    "$PCF_TILE_PAS_ADMIN_PASS"
      messagePrint " - PAS Administrator Email"       "$PCF_TILE_PAS_ADMIN_EMAIL"
    fi
  fi

  if [ ${missing_variables} -eq 1 ]; then
    echo "  --------------------------------------------------------------------------------------------------------------"
    echo "  IMPORTANT: Please set the missing environment variables either in your shell or in the pcfconfig"
    echo "             configuration file ~/.pcfconfig and set all variables with the 'export' notation"
    echo "             ie. => export AZURE_PKS_TLS_CERTIFICATE=/home/demouser/certs/cert.pem"
    echo "  --------------------------------------------------------------------------------------------------------------"
    exit 1
  fi
fi

# --- VERIFY CLI TOOLS ---
write_line
checkCloudCLI
write_line

checkCloudAccess
installJumpHost jump-${PCF_DEPLOYMENT_ENV_NAME}.${AWS_HOSTED_DNS_DOMAIN}

createENVfile $DEPLOYMENT /tmp/deployPCFenv
$SCP_COMMAND /tmp/deployPCFenv ${SSH_USER}@${SSH_HOST}:/tmp > /dev/null 2>&1

$SSH_COMMAND -n "[ -f \$HOME/pcfconfig/scripts/deployPCFwrapper.sh ] && \$HOME/pcfconfig/scripts/deployPCFwrapper.sh $envFile"
$SSH_COMMAND -n "tail -n 1000 -f /tmp/pcfconfig.log --pid \$(cat /tmp/pcfconfig.pid)"

exit 1
$SSH_COMMAND -n "~/pcfconfig/pcfconfig.sh $ARGS"
$SSH_COMMAND -n "tail -n 1000 -f /tmp/pcfconfig.log --pid \$(cat /tmp/pcfconfig.pid)"



